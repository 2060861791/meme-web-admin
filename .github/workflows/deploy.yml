name: Deploy Vue3 Frontend-Admin

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ ç™»å½•æœåŠ¡å™¨æ‹‰å–æ›´æ–°å¹¶æ„å»ºé•œåƒ
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # é¡¹ç›®è·¯å¾„
            PROJECT_DIR=/home/${{ secrets.SSH_USER }}/vue-admin-project
            IMAGE_NAME="vue-app-admin:latest"

            echo "ğŸ“‚ è¿›å…¥é¡¹ç›®ç›®å½•"
            cd $PROJECT_DIR

            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç "
            git reset --hard
            git clean -fd
            git pull origin main

            echo "ğŸ§¹ åˆ é™¤æ—§ Docker é•œåƒï¼ˆå¦‚å­˜åœ¨ï¼‰"
            sudo docker rmi -f $IMAGE_NAME || echo "é•œåƒä¸å­˜åœ¨"

            echo "ğŸ³ æ„å»ºæ–° Docker é•œåƒ"
            DOCKER_BUILDKIT=1 sudo docker build -t $IMAGE_NAME .

            echo "ğŸ›‘ åœæ­¢å¹¶ç§»é™¤æ—§å®¹å™¨ï¼ˆå¦‚å­˜åœ¨ï¼‰"
            sudo docker stop vue-app-admin || echo "å®¹å™¨æœªè¿è¡Œ"
            sudo docker rm vue-app-admin || echo "å®¹å™¨ä¸å­˜åœ¨"
            sudo fuser -k 8081/tcp || echo "ç«¯å£æœªå ç”¨"

            echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨"
            sudo docker run -d --restart always -p 8081:80 --name vue-app-admin $IMAGE_NAME
